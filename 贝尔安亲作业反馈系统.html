<!DOCTYPE html>
<html lang="zh-CN">
<head>            
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è´å°”å®‰äº²ä½œä¸šåé¦ˆç³»ç»Ÿ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: #f5f7fa;
            padding: 15px;
            color: #333;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .step {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .step h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            line-height: 1.5;
            resize: vertical;
            font-family: "Consolas", monospace;
            margin-bottom: 10px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            user-select: none;
        }
        
        .btn:active {
            background: #2980b9;
            transform: scale(0.98);
        }
        
        .btn-success {
            background: #2ecc71;
        }
        
        .btn-success:active {
            background: #27ae60;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .student-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .info-item label {
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        
        .info-item input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            min-height: 44px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .result-box {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            min-height: 180px;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 16px;
            margin-top: 15px;
            overflow-wrap: break-word;
            word-wrap: break-word;
            -webkit-overflow-scrolling: touch;
        }
        
        .comments-section {
            margin: 15px 0;
        }
        
        .comment-category {
            margin-bottom: 15px;
        }
        
        .comment-category h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .comment-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .comment-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            min-height: 44px;
        }
        
        .comment-checkbox:active {
            border-color: #3498db;
            background-color: #f0f8ff;
        }
        
        .comment-checkbox input {
            width: 20px;
            height: 20px;
            accent-color: #3498db;
            flex-shrink: 0;
        }
        
        .comment-checkbox label {
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .stat-value {
            font-size: 22px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 3px;
        }
        
        .stat-label {
            font-size: 13px;
            color: #6c757d;
        }
        
        .subject-item {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #3498db;
            font-size: 14px;
        }
        
        .hint {
            background: #e8f4fc;
            padding: 10px 12px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .error {
            background: #ffeaea;
            padding: 10px 12px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 14px;
            color: #d32f2f;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .comment-checkboxes {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .step h3 {
                font-size: 18px;
            }
            
            textarea {
                font-size: 16px;
                min-height: 120px;
            }
            
            .info-item input {
                font-size: 16px;
            }
            
            .result-box {
                font-size: 15px;
            }
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .loading.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div>è§£æä¸­...</div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>è´å°”å®‰äº²ä½œä¸šåé¦ˆç³»ç»Ÿ</h1>
            <!-- å·²ç§»é™¤"æ™ºèƒ½è§£ææ‰«æå…¨èƒ½ç‹æ ¼å¼"æ ‡æ³¨ -->
        </div>
        
        <div class="step">
            <h3>ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šç²˜è´´æ‰«ææ–‡æœ¬</h3>
            <textarea id="ocrText">è´å°”å®‰äº²ä½œä¸šä»»åŠ¡å•
å¼€å§‹ä»Šå¤©çš„ä»»åŠ¡é—¯å…³å§ï¼
å­¦ç”Ÿå§“åï¼š
æ—¥æœŸï¼š
è¾…å¯¼è€å¸ˆï¼š
ç‰›æ¸²å„¿
2026/01/15
å°é«˜è€å¸ˆ
é”™é¢˜åŸå› å‚è€ƒæ¨¡æ¿
æ•°å­¦
è¯­æ–‡
è‹±è¯­
1ï¼è®¡ç®—ç²—å¿ƒ
1ï¼ç”Ÿå­—å†™é”™
1ï¼å•è¯æ‹¼å†™é”™è¯¯
2ï¼æ¦‚å¿µç†è§£ä¸æ¸…
2ï¼æ‹¼éŸ³é”™è¯¯
2ï¼è¯­æ³•é”™è¯¯
3ï¼å…¬å¼è®°é”™
3ï¼é˜…è¯»ç†è§£åå·®
3ï¼æ—¶æ€æ··æ·†
4ï¼å®¡é¢˜ä¸ä»”ç»†
4ï¼ä½œæ–‡è·‘é¢˜
4ï¼å•å¤æ•°é”™è¯¯
5å•ä½æ¢ç®—é”™è¯¯
5è¯¾æ–‡èƒŒè¯µä¸ç†Ÿ
5ï¼å¤§å°å†™é”™è¯¯
6ï¼ä»‹è¯ä½¿ç”¨ä¸å½“
6ï¼æ­¥éª¤ä¸å®Œæ•´
6ï¼æ ‡ç‚¹ç¬¦å·é”™
ç§‘ç›®
ä½œä¸šä»»åŠ¡å†…å®¹
é¢„ä¼°æ—¶é—´
å®é™…æ—¶é—´
å®Œæˆæƒ…å†µ
é”™é¢˜æ•°é‡
é”™é¢˜åŸå› 
æ•°å­¦
å¤§å·
40
50
å®Œæˆ
5
1,2,4
æ•°å­¦
è®¡ç®—ä¸€é¡µ
15
20
å®Œæˆ
2
1
è¯­æ–‡
é˜…è¯»ç†è§£ä¸€ç¯‡
20
25
å®Œæˆ
3
3
è¯­æ–‡
èƒŒè¯µè¯¾æ–‡11è¯¾1-2è‡ªç„¶æ®µ
15
20
å®Œæˆ

5
è‹±è¯­
å°å·æ­£åé¢
20
20
å®Œæˆ
3
5
è‹±è¯­
èƒŒè¯µè¯¾æ–‡10è¯¾
15

X


çºªå¾‹è‰¯å¥½ï¼š
5
æ³¨æ„åŠ›é›†ä¸­ï¼š
è‡ªå·±æ€è€ƒï¼š
ä¸ç©ºå¤ªå¤šé¢˜ï¼š
å®Œæˆå¿«ï¼š
20
æ€»åˆ†ï¼š
25
é”™é¢˜å°‘ï¼š
æ•™å¸ˆè¯„è¯­ï¼ˆè¯·å‹¾é€‰é€‚ç”¨é¡¹ï¼‰ï¼š
å¥½çš„æ–¹é¢ï¼š
éœ€æ”¹è¿›æ–¹é¢ï¼š
â–¡ä½œä¸šå®Œæˆè®¤çœŸä»”ç»†
â–¡ä½œä¸šå®Œæˆè¾ƒé©¬è™
å‚ç‹¬ç«‹æ€è€ƒèƒ½åŠ›å¼º
æ³¨æ„åŠ›ä¸é›†ä¸­
â–¡æ³¨æ„åŠ›é›†ä¸­ï¼Œæ•ˆç‡é«˜
éœ€è¦å¤šæ¬¡æé†’
ä¹¦å†™å·¥æ•´è§„èŒƒ
â–¡é‡åˆ°å›°éš¾å®¹æ˜“æ”¾å¼ƒ
â–¡ç§¯ææé—®ï¼Œå–„äºæ€è€ƒ
â–¡ä¹¦å†™æ½¦è‰ä¸è§„èŒƒ
è´å°”å®‰äº²æ‰˜ç®¡ä¸­å¿ƒ ä½œä¸šä»»åŠ¡å•</textarea>
            
            <div class="btn-group">
                <button class="btn" id="parseBtn">ğŸ” æ™ºèƒ½è§£æ</button>
                <button class="btn" id="clearBtn">ğŸ—‘ï¸ æ¸…ç©º</button>
            </div>
        </div>
        
        <div class="step">
            <h3>ğŸ‘¤ ç¬¬äºŒæ­¥ï¼šç¡®è®¤å­¦ç”Ÿä¿¡æ¯</h3>
            <div class="student-info">
                <div class="info-item">
                    <label>å­¦ç”Ÿå§“å</label>
                    <input type="text" id="studentName" placeholder="è¯·æ‰‹åŠ¨è¾“å…¥" value="ç‰›æ¸²å„¿">
                </div>
                <div class="info-item">
                    <label>æ—¥æœŸ</label>
                    <input type="text" id="date" placeholder="è‡ªåŠ¨è®¾ç½®ä¸ºä»Šæ—¥">
                </div>
                <div class="info-item">
                    <label>è¾…å¯¼è€å¸ˆ</label>
                    <input type="text" id="teacherName" placeholder="è¯·æ‰‹åŠ¨è¾“å…¥" value="å°é«˜è€å¸ˆ">
                </div>
            </div>
        </div>
        
        <div class="step">
            <h3>ğŸ“Š ç¬¬ä¸‰æ­¥ï¼šæŸ¥çœ‹ä½œä¸šåˆ†æ</h3>
            
            <div id="statsContainer">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalTasks">0</div>
                        <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="completedTasks">0</div>
                        <div class="stat-label">å®Œæˆæ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalErrors">0</div>
                        <div class="stat-label">é”™é¢˜æ€»æ•°</div>
                    </div>
                </div>
                
                <h4>å„ç§‘ä½œä¸šè¯¦æƒ…ï¼š</h4>
                <div id="subjectList">
                    <div class="hint">è¯·å…ˆè§£ææ–‡æœ¬å†…å®¹</div>
                </div>
            </div>
        </div>
        
        <div class="step">
            <h3>âœï¸ ç¬¬å››æ­¥ï¼šé€‰æ‹©æ•™å¸ˆè¯„è¯­</h3>
            
            <div class="comments-section">
                <div class="comment-category">
                    <h4>âœ… å¥½çš„æ–¹é¢ï¼š</h4>
                    <div class="comment-checkboxes">
                        <label class="comment-checkbox">
                            <input type="checkbox" name="good" value="ä½œä¸šå®Œæˆè®¤çœŸä»”ç»†"> 
                            <span>ä½œä¸šå®Œæˆè®¤çœŸä»”ç»†</span>
                        </label>
                        <label class="comment-checkbox">
                            <input type="checkbox" name="good" value="ç‹¬ç«‹æ€è€ƒå’ŒåŠ¨æ‰‹èƒ½åŠ›å¼º">
                            <span>ç‹¬ç«‹æ€è€ƒå’ŒåŠ¨æ‰‹èƒ½åŠ›å¼º</span>
                        </label>
                        <label class="comment-checkbox">
                            <input type="checkbox" name="good" value="æ³¨æ„åŠ›é›†ä¸­ï¼Œæ•ˆç‡é«˜">
                            <span>æ³¨æ„åŠ›é›†ä¸­ï¼Œæ•ˆç‡é«˜</span>
                        </label>
                        <label class="comment-checkbox">
                            <input type="checkbox" name="good" value="ä¹¦å†™å·¥æ•´è§„èŒƒ">
                            <span>ä¹¦å†™å·¥æ•´è§„èŒƒ</span>
                        </label>
                        <label class="comment-checkbox">
                            <input type="checkbox" name="good" value="ç§¯ææé—®ï¼Œå–„äºæ€è€ƒ">
                            <span>ç§¯ææé—®ï¼Œå–„äºæ€è€ƒ</span>
                        </label>
                    </div>
                </div>
                
                <div class="comment-category">
                    <h4>âš ï¸ éœ€æ”¹è¿›æ–¹é¢ï¼š</h4>
                    <div class="comment-checkboxes">
                        <label class="comment-checkbox">
                            <input type="checkbox" name="improve" value="ä½œä¸šå®Œæˆè¾ƒé©¬è™">
                            <span>ä½œä¸šå®Œæˆè¾ƒé©¬è™</span>
                        </label>
                        <label class="comment-checkbox">
                            <input type="checkbox" name="improve" value="æ³¨æ„åŠ›ä¸é›†ä¸­">
                            <span>æ³¨æ„åŠ›ä¸é›†ä¸­</span>
                        </label>
                        <label class="comment-checkbox">
                            <input type="checkbox" name="improve" value="éœ€è¦å¤šæ¬¡æé†’">
                            <span>éœ€è¦å¤šæ¬¡æé†’</span>
                        </label>
                        <label class="comment-checkbox">
                            <input type="checkbox" name="improve" value="é‡åˆ°å›°éš¾å®¹æ˜“æ”¾å¼ƒ">
                            <span>é‡åˆ°å›°éš¾å®¹æ˜“æ”¾å¼ƒ</span>
                        </label>
                        <label class="comment-checkbox">
                            <input type="checkbox" name="improve" value="ä¹¦å†™æ½¦è‰ä¸è§„èŒƒ">
                            <span>ä¹¦å†™æ½¦è‰ä¸è§„èŒƒ</span>
                        </label>
                        <label class="comment-checkbox">
                            <input type="checkbox" name="improve" value="å­¦æ ¡æ•°å­¦æ–°è¯¾çŸ¥è¯†æŒæ¡ä¸ä½³ï¼Œæœ‰å¾…æé«˜è¯¾å ‚æ•ˆç‡">
                            <span>å­¦æ ¡æ•°å­¦æ–°è¯¾çŸ¥è¯†æŒæ¡ä¸ä½³ï¼Œæœ‰å¾…æé«˜è¯¾å ‚æ•ˆç‡</span>
                        </label>
                        <label class="comment-checkbox">
                            <input type="checkbox" name="improve" value="è¯¾å ‚ä»»åŠ¡æ²¡æœ‰åœ¨æ ¡å†…å®Œæˆï¼Œéœ€è¦æé«˜è¯¾å ‚æ•ˆç‡">
                            <span>è¯¾å ‚ä»»åŠ¡æ²¡æœ‰åœ¨æ ¡å†…å®Œæˆï¼Œéœ€è¦æé«˜è¯¾å ‚æ•ˆç‡</span>
                        </label>
                    </div>
                </div>
                
                <div class="info-item">
                    <label>è¡¥å……è¯„è¯­ï¼š</label>
                    <input type="text" id="additionalComment" placeholder="å¯æ·»åŠ å…¶ä»–è¯„è¯­...">
                </div>
            </div>
        </div>
        
        <div class="step">
            <h3>ğŸ“ ç¬¬äº”æ­¥ï¼šç”Ÿæˆåé¦ˆ</h3>
            
            <div class="btn-group">
                <button class="btn btn-success" id="generateBtn">âœ¨ ç”Ÿæˆåé¦ˆå†…å®¹</button>
                <button class="btn" id="copyBtn">ğŸ“‹ å¤åˆ¶å†…å®¹</button>
                <button class="btn" id="saveBtn">ğŸ’¾ ä¿å­˜æ–‡æœ¬</button>
            </div>
            
            <div class="result-box" id="resultBox">
                åé¦ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º...
            </div>
        </div>
    </div>

    <script>
        // é”™é¢˜åŸå› æ˜ å°„è¡¨
        const errorReasons = {
            'æ•°å­¦': {
                '1': 'è®¡ç®—ç²—å¿ƒ',
                '2': 'æ¦‚å¿µç†è§£ä¸æ¸…', 
                '3': 'å…¬å¼è®°é”™',
                '4': 'å®¡é¢˜ä¸ä»”ç»†',
                '5': 'å•ä½æ¢ç®—é”™è¯¯',
                '6': 'æ­¥éª¤ä¸å®Œæ•´'
            },
            'è¯­æ–‡': {
                '1': 'ç”Ÿå­—å†™é”™',
                '2': 'æ‹¼éŸ³é”™è¯¯',
                '3': 'é˜…è¯»ç†è§£åå·®',
                '4': 'ä½œæ–‡è·‘é¢˜',
                '5': 'è¯¾æ–‡èƒŒè¯µä¸ç†Ÿ',
                '6': 'æ ‡ç‚¹ç¬¦å·é”™è¯¯'
            },
            'è‹±è¯­': {
                '1': 'å•è¯æ‹¼å†™é”™è¯¯',
                '2': 'è¯­æ³•é”™è¯¯',
                '3': 'æ—¶æ€æ··æ·†',
                '4': 'å•å¤æ•°é”™è¯¯',
                '5': 'å¤§å°å†™é”™è¯¯',
                '6': 'ä»‹è¯ä½¿ç”¨ä¸å½“'
            },
            'å®‰äº²ä½œä¸š': {
                '1': 'è®¡ç®—ç²—å¿ƒ',
                '2': 'æ¦‚å¿µç†è§£ä¸æ¸…',
                '3': 'å®¡é¢˜ä¸ä»”ç»†',
                '4': 'æ­¥éª¤ä¸å®Œæ•´'
            }
        };

        // å…¨å±€å˜é‡å­˜å‚¨è§£æåçš„ä½œä¸šæ•°æ®
        let parsedAssignments = [];
        
        // DOMå…ƒç´ å¼•ç”¨
        const parseBtn = document.getElementById('parseBtn');
        const clearBtn = document.getElementById('clearBtn');
        const generateBtn = document.getElementById('generateBtn');
        const copyBtn = document.getElementById('copyBtn');
        const saveBtn = document.getElementById('saveBtn');
        const loading = document.getElementById('loading');
        
        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        function showLoading() {
            loading.classList.add('active');
        }
        
        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function hideLoading() {
            loading.classList.remove('active');
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ¸…ç†å’Œæ ‡å‡†åŒ–æ–‡æœ¬
        function cleanAndNormalizeText(text) {
            if (!text) return '';
            
            // ç»Ÿä¸€æ¢è¡Œç¬¦ä¸º\n
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // å¤„ç†ç§»åŠ¨è®¾å¤‡å¯èƒ½å‡ºç°çš„ç‰¹æ®Šç©ºæ ¼
            text = text.replace(/[\u00A0\u1680\u2000-\u200B\u202F\u205F\u3000\uFEFF]/g, ' ');
            
            // å¤„ç†å…¨è§’å­—ç¬¦
            text = text.replace(/ï¼Œ/g, ',').replace(/ï¼›/g, ';').replace(/ï¼š/g, ':');
            
            // å¤„ç†ä¸­æ–‡æ•°å­—åé¢çš„ç‚¹ï¼ˆå¦‚1ï¼è®¡ç®—ç²—å¿ƒï¼‰
            text = text.replace(/(\d)ï¼/g, '$1.');
            
            // ç§»é™¤å¤šä½™çš„ç©ºæ ¼ï¼Œä½†ä¿ç•™æ¢è¡Œ
            const lines = text.split('\n');
            const cleanedLines = lines.map(line => {
                // ç§»é™¤è¡Œé¦–å°¾ç©ºæ ¼
                line = line.trim();
                // å°†å¤šä¸ªè¿ç»­ç©ºæ ¼åˆå¹¶ä¸ºä¸€ä¸ª
                line = line.replace(/\s+/g, ' ');
                return line;
            });
            
            return cleanedLines.join('\n');
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šå°†é”™é¢˜åŸå› å­—ç¬¦ä¸²æ ‡å‡†åŒ–
        function normalizeErrorReasons(str) {
            if (!str) return '';
            let normalized = str.replace(/ï¼Œ/g, ',');
            normalized = normalized.replace(/\s/g, '');
            return normalized;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥å­—ç¬¦ä¸²æ˜¯å¦æ˜¯é”™é¢˜åŸå› æ ¼å¼
        function isErrorReasonFormat(str) {
            if (!str) return false;
            const normalized = normalizeErrorReasons(str);
            return normalized.includes(',') || /^[\d,]+$/.test(normalized);
        }
        
        // æ™ºèƒ½è§£æOCRæ–‡æœ¬ - å¢å¼ºç§»åŠ¨è®¾å¤‡å…¼å®¹æ€§
        function parseAssignmentsFromOCR(text) {
            // æ¸…ç†å’Œæ ‡å‡†åŒ–æ–‡æœ¬
            text = cleanAndNormalizeText(text);
            
            // æŒ‰è¡Œåˆ†å‰²
            const lines = text.split('\n').map(line => line.trim());
            const assignments = [];
            
            console.log('æ¸…ç†åçš„è¡Œæ•°:', lines.length);
            console.log('æ¸…ç†åçš„å‰20è¡Œ:', lines.slice(0, 20));
            
            // æŸ¥æ‰¾è¡¨æ ¼æ•°æ®çš„å¼€å§‹ä½ç½®ï¼ˆæ‰¾åˆ°"ç§‘ç›®"è¡Œï¼‰
            let tableStartIndex = -1;
            for (let i = 0; i < lines.length; i++) {
                // æ›´çµæ´»çš„åŒ¹é…ï¼šåŒ…å«"ç§‘ç›®"å…³é”®è¯
                if (lines[i].includes('ç§‘ç›®') || lines[i] === 'ç§‘ç›®') {
                    tableStartIndex = i;
                    console.log('æ‰¾åˆ°ç§‘ç›®è¡Œï¼Œç´¢å¼•:', i, 'å†…å®¹:', lines[i]);
                    break;
                }
            }
            
            if (tableStartIndex === -1) {
                // å°è¯•æ›´å®½æ¾çš„åŒ¹é…
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].indexOf('ç§‘') >= 0 && lines[i].indexOf('ç›®') >= 0) {
                        tableStartIndex = i;
                        console.log('å®½æ¾åŒ¹é…æ‰¾åˆ°ç§‘ç›®è¡Œï¼Œç´¢å¼•:', i, 'å†…å®¹:', lines[i]);
                        break;
                    }
                }
            }
            
            if (tableStartIndex === -1) {
                console.error('æœªæ‰¾åˆ°è¡¨æ ¼å¼€å§‹ä½ç½®');
                console.log('æ‰€æœ‰è¡Œ:', lines);
                return null;
            }
            
            // æ‰¾åˆ°æ•°æ®å¼€å§‹ä½ç½®ï¼ˆè·³è¿‡è¡¨å¤´è¡Œï¼‰
            const subjectKeywords = ['æ•°å­¦', 'è¯­æ–‡', 'è‹±è¯­', 'å®‰äº²ä½œä¸š', 'å®‰äº²ä½œ'];
            let dataStartIndex = -1;
            
            // ä»"ç§‘ç›®"è¡Œå¼€å§‹æŸ¥æ‰¾ç¬¬ä¸€ä¸ªç§‘ç›®å…³é”®è¯
            for (let i = tableStartIndex + 1; i < lines.length; i++) {
                // æ£€æŸ¥æ˜¯å¦åŒ…å«ç§‘ç›®å…³é”®è¯
                const line = lines[i];
                let foundSubject = false;
                let matchedSubject = '';
                
                for (const keyword of subjectKeywords) {
                    if (line === keyword || line.includes(keyword)) {
                        foundSubject = true;
                        matchedSubject = keyword;
                        break;
                    }
                }
                
                if (foundSubject) {
                    dataStartIndex = i;
                    console.log('æ‰¾åˆ°æ•°æ®å¼€å§‹ä½ç½®ï¼Œç´¢å¼•:', i, 'ç§‘ç›®:', matchedSubject, 'å†…å®¹:', line);
                    break;
                }
                
                // å¦‚æœé‡åˆ°ç§¯åˆ†å¥–åŠ±æƒ…å†µï¼Œè¯´æ˜è¡¨æ ¼ç»“æŸäº†
                if (line.includes('çºªå¾‹è‰¯å¥½') || line.includes('ç§¯åˆ†å¥–åŠ±') || 
                    line.includes('æ•™å¸ˆè¯„è¯­') || line.includes('è´å°”å®‰äº²')) {
                    console.log('åˆ°è¾¾è¡¨æ ¼ç»“æŸï¼Œå½“å‰è¡Œ:', line);
                    break;
                }
            }
            
            if (dataStartIndex === -1) {
                console.error('æœªæ‰¾åˆ°æ•°æ®å¼€å§‹ä½ç½®');
                console.log('ç§‘ç›®è¡Œåçš„è¡Œ:', lines.slice(tableStartIndex, tableStartIndex + 20));
                return null;
            }
            
            console.log('è¡¨æ ¼å¼€å§‹ä½ç½®:', tableStartIndex, 'æ•°æ®å¼€å§‹ä½ç½®:', dataStartIndex);
            
            // ä»æ•°æ®å¼€å§‹ä½ç½®å¼€å§‹ï¼Œè§£æä½œä¸šé¡¹
            let currentIndex = dataStartIndex;
            
            while (currentIndex < lines.length) {
                // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾è¡¨æ ¼ç»“æŸ
                const currentLine = lines[currentIndex];
                if (!currentLine || 
                    currentLine.includes('çºªå¾‹è‰¯å¥½') || 
                    currentLine.includes('ç§¯åˆ†å¥–åŠ±') ||
                    currentLine.startsWith('æ€»åˆ†') ||
                    currentLine.includes('æ•™å¸ˆè¯„è¯­') ||
                    currentLine.includes('è´å°”å®‰äº²')) {
                    console.log('åˆ°è¾¾è¡¨æ ¼ç»“æŸï¼Œå½“å‰è¡Œ:', currentLine);
                    break;
                }
                
                // æ£€æŸ¥å½“å‰è¡Œæ˜¯å¦æ˜¯ç§‘ç›®å…³é”®è¯
                let isSubjectLine = false;
                let subject = '';
                
                for (const keyword of subjectKeywords) {
                    if (currentLine === keyword || currentLine.includes(keyword)) {
                        isSubjectLine = true;
                        subject = keyword;
                        if (subject === 'å®‰äº²ä½œ') {
                            subject = 'å®‰äº²ä½œä¸š';
                        }
                        break;
                    }
                }
                
                if (!isSubjectLine) {
                    // å¦‚æœä¸æ˜¯ç§‘ç›®è¡Œï¼Œç»§ç»­æŸ¥æ‰¾
                    currentIndex++;
                    continue;
                }
                
                // å°è¯•è¯»å–æ¥ä¸‹æ¥çš„6è¡Œæ•°æ®
                const assignment = {
                    subject: subject,
                    task: '',
                    estimatedTime: '0',
                    actualTime: '',
                    completed: true,
                    errorCount: '0',
                    errorReasons: ''
                };
                
                // è¯»å–ä½œä¸šå†…å®¹
                if (currentIndex + 1 < lines.length) {
                    assignment.task = lines[currentIndex + 1] || '';
                }
                
                // è¯»å–é¢„ä¼°æ—¶é—´
                if (currentIndex + 2 < lines.length) {
                    assignment.estimatedTime = lines[currentIndex + 2] || '0';
                    // æ¸…ç†æ—¶é—´ä¸­çš„éæ•°å­—å­—ç¬¦
                    assignment.estimatedTime = assignment.estimatedTime.replace(/\D/g, '') || '0';
                }
                
                // è¯»å–å®é™…æ—¶é—´
                if (currentIndex + 3 < lines.length) {
                    assignment.actualTime = lines[currentIndex + 3] || '';
                    // æ¸…ç†æ—¶é—´ä¸­çš„éæ•°å­—å­—ç¬¦
                    assignment.actualTime = assignment.actualTime.replace(/\D/g, '');
                }
                
                // è¯»å–å®Œæˆæƒ…å†µ
                if (currentIndex + 4 < lines.length) {
                    const completionStatus = lines[currentIndex + 4];
                    if (completionStatus === 'å®Œæˆ' || completionStatus === 'æœªå®Œæˆ' || completionStatus === 'X') {
                        assignment.completed = (completionStatus === 'å®Œæˆ');
                    } else {
                        // æ ¹æ®å®é™…æ—¶é—´åˆ¤æ–­
                        assignment.completed = !!assignment.actualTime && assignment.actualTime !== '';
                    }
                }
                
                // è¯»å–é”™é¢˜æ•°é‡
                if (currentIndex + 5 < lines.length) {
                    const errorCountStr = lines[currentIndex + 5];
                    if (errorCountStr === '' || errorCountStr === ' ') {
                        assignment.errorCount = '0';
                    } else if (errorCountStr && /^\d+$/.test(errorCountStr)) {
                        assignment.errorCount = errorCountStr;
                    }
                }
                
                // è¯»å–é”™é¢˜åŸå› 
                if (currentIndex + 6 < lines.length) {
                    const errorReasonStr = lines[currentIndex + 6];
                    if (errorReasonStr && isErrorReasonFormat(errorReasonStr)) {
                        assignment.errorReasons = normalizeErrorReasons(errorReasonStr);
                    }
                }
                
                // ç‰¹æ®Šå¤„ç†ï¼šè‹±è¯­èƒŒè¯µè¯¾æ–‡æ²¡æœ‰é”™é¢˜
                if (assignment.subject === 'è‹±è¯­' && 
                    assignment.task && 
                    (assignment.task.includes('èƒŒè¯µ') || assignment.task.includes('èƒŒè¯µè¯¾æ–‡'))) {
                    assignment.errorCount = '0';
                    assignment.errorReasons = '';
                }
                
                console.log('è§£æä½œä¸šé¡¹:', assignment);
                assignments.push(assignment);
                
                // ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå¯èƒ½çš„ä½œä¸šé¡¹ï¼ˆé€šå¸¸é—´éš”7è¡Œï¼Œä½†ç§»åŠ¨è®¾å¤‡å¯èƒ½æœ‰ç©ºè¡Œï¼‰
                currentIndex += 7;
                
                // è·³è¿‡å¯èƒ½çš„å¤šä½™ç©ºè¡Œ
                while (currentIndex < lines.length && 
                       (lines[currentIndex] === '' || lines[currentIndex] === ' ')) {
                    currentIndex++;
                }
            }
            
            console.log('è§£æç»“æœ:', assignments);
            return assignments;
        }
        
        // è§£ææ–‡æœ¬å†…å®¹
        function parseContent() {
            const ocrText = document.getElementById('ocrText').value;
            if (!ocrText.trim()) {
                alert('è¯·è¾“å…¥æ‰«ææ–‡æœ¬å†…å®¹ï¼');
                return;
            }
            
            showLoading();
            
            // ä½¿ç”¨setTimeoutè®©UIæœ‰æœºä¼šæ›´æ–°åŠ è½½çŠ¶æ€
            setTimeout(() => {
                try {
                    // è§£æä½œä¸šæ•°æ®
                    parsedAssignments = parseAssignmentsFromOCR(ocrText);
                    
                    if (parsedAssignments === null || parsedAssignments.length === 0) {
                        document.getElementById('subjectList').innerHTML = 
                            '<div class="error">æœªèƒ½è§£æåˆ°ä½œä¸šæ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡æœ¬æ ¼å¼ï¼</div>';
                        console.error('è§£æå¤±è´¥ï¼ŒåŸå§‹æ–‡æœ¬:', ocrText);
                    } else {
                        // æ›´æ–°ç»Ÿè®¡å’Œæ˜¾ç¤º
                        updateStatisticsAndDisplay(parsedAssignments);
                    }
                } catch (error) {
                    console.error('è§£æé”™è¯¯:', error);
                    document.getElementById('subjectList').innerHTML = 
                        '<div class="error">è§£æå‡ºé”™ï¼š' + error.message + '</div>';
                } finally {
                    hideLoading();
                }
            }, 100);
        }
        
        // æ›´æ–°ç»Ÿè®¡å’Œæ˜¾ç¤º
        function updateStatisticsAndDisplay(assignments) {
            const total = assignments.length;
            const completed = assignments.filter(a => a.completed).length;
            const errorCount = assignments.reduce((sum, a) => {
                const count = a.errorCount ? parseInt(a.errorCount) : 0;
                return sum + (isNaN(count) ? 0 : count);
            }, 0);
            
            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('totalErrors').textContent = errorCount;
            
            // æ›´æ–°ä½œä¸šè¯¦æƒ…æ˜¾ç¤º
            const subjectList = document.getElementById('subjectList');
            subjectList.innerHTML = '';
            
            assignments.forEach(assignment => {
                const div = document.createElement('div');
                div.className = 'subject-item';
                
                // è·å–é”™é¢˜åŸå› æè¿°
                let errorReasonsDesc = 'æ— ';
                if (assignment.errorReasons && assignment.errorReasons !== '') {
                    const normalizedReasons = normalizeErrorReasons(assignment.errorReasons);
                    const reasonCodes = normalizedReasons.split(',').filter(code => code.trim() !== '');
                    const reasons = [];
                    reasonCodes.forEach(code => {
                        if (code && code.trim()) {
                            const subjectErrors = errorReasons[assignment.subject];
                            if (subjectErrors && subjectErrors[code.trim()]) {
                                reasons.push(subjectErrors[code.trim()]);
                            }
                        }
                    });
                    if (reasons.length > 0) {
                        errorReasonsDesc = reasons.join('ã€');
                    }
                }
                
                // å¯¹äºæœªå®Œæˆçš„ä½œä¸šï¼Œå®é™…æ—¶é—´ç•™ç©º
                const actualTimeDisplay = assignment.completed && assignment.actualTime ? assignment.actualTime : '';
                const errorCountDisplay = assignment.errorCount && assignment.errorCount !== '' ? assignment.errorCount : '0';
                const statusEmoji = assignment.completed ? 'âœ…' : 'âŒ';
                
                // æ—¶é—´æè¿°æ›´æ¸…æ™°
                let timeDescription = `é¢„è®¡${assignment.estimatedTime}åˆ†é’Ÿ`;
                if (actualTimeDisplay) {
                    timeDescription += `ï¼Œå®é™…å®Œæˆ${actualTimeDisplay}åˆ†é’Ÿ`;
                } else if (!assignment.completed) {
                    timeDescription += `ï¼Œæœªå®Œæˆ`;
                }
                
                // é”™é¢˜æè¿°
                let errorDescription = '';
                if (assignment.errorReasons && assignment.errorReasons !== '') {
                    errorDescription = `é”™é¢˜ï¼š${errorCountDisplay}é¢˜ï¼ˆ${errorReasonsDesc}ï¼‰`;
                } else {
                    errorDescription = `é”™é¢˜ï¼š${errorCountDisplay}é¢˜`;
                }
                
                div.innerHTML = `
                    <div><strong>${assignment.subject}</strong> - ${assignment.task}</div>
                    <div>${timeDescription} ${statusEmoji}</div>
                    <div>${errorDescription}</div>
                `;
                
                subjectList.appendChild(div);
            });
        }
        
        // ç”Ÿæˆåé¦ˆå†…å®¹
        function generateFeedback() {
            const studentName = document.getElementById('studentName').value || 'å­¦ç”Ÿ';
            const date = document.getElementById('date').value || new Date().toLocaleDateString('zh-CN');
            const teacherName = document.getElementById('teacherName').value || 'è¾…å¯¼è€å¸ˆ';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è§£æçš„ä½œä¸šæ•°æ®
            if (parsedAssignments.length === 0) {
                alert('è¯·å…ˆè§£ææ–‡æœ¬å†…å®¹ï¼');
                return;
            }
            
            showLoading();
            
            setTimeout(() => {
                try {
                    // ç»Ÿè®¡ä¿¡æ¯
                    const total = parsedAssignments.length;
                    const completed = parsedAssignments.filter(a => a.completed).length;
                    const errorCount = parsedAssignments.reduce((sum, a) => {
                        const count = a.errorCount ? parseInt(a.errorCount) : 0;
                        return sum + (isNaN(count) ? 0 : count);
                    }, 0);
                    
                    // è®¡ç®—æ€»æ—¶é—´
                    const totalEstimatedTime = parsedAssignments.reduce((sum, a) => sum + (parseInt(a.estimatedTime) || 0), 0);
                    const totalActualTime = parsedAssignments
                        .filter(a => a.completed && a.actualTime)
                        .reduce((sum, a) => sum + (parseInt(a.actualTime) || 0), 0);
                    
                    // è®¡ç®—æ—¶é—´ä½¿ç”¨æƒ…å†µ
                    let timeUsageDescription = '';
                    if (totalActualTime > 0) {
                        const timeRatio = totalActualTime / totalEstimatedTime;
                        if (timeRatio < 0.9) {
                            timeUsageDescription = 'ç”¨æ—¶åˆç†ï¼Œæ•ˆç‡è¾ƒé«˜';
                        } else if (timeRatio <= 1.1) {
                            timeUsageDescription = 'ç”¨æ—¶æ­£å¸¸ï¼ŒæŒ‰è®¡åˆ’å®Œæˆ';
                        } else if (timeRatio <= 1.3) {
                            timeUsageDescription = 'ç”¨æ—¶ç¨å¤šï¼Œéœ€æ³¨æ„æ—¶é—´ç®¡ç†';
                        } else {
                            timeUsageDescription = 'ç”¨æ—¶è¾ƒå¤šï¼Œéœ€æé«˜æ•ˆç‡';
                        }
                    } else {
                        timeUsageDescription = 'éƒ¨åˆ†ä½œä¸šæœªå®Œæˆ';
                    }
                    
                    // æŒ‰ç§‘ç›®ç»Ÿè®¡é”™é¢˜æ•°
                    const subjectErrorCounts = {};
                    parsedAssignments.forEach(assignment => {
                        if (!subjectErrorCounts[assignment.subject]) {
                            subjectErrorCounts[assignment.subject] = 0;
                        }
                        const count = assignment.errorCount ? parseInt(assignment.errorCount) : 0;
                        subjectErrorCounts[assignment.subject] += (isNaN(count) ? 0 : count);
                    });
                    
                    // è·å–é€‰æ‹©çš„è¯„è¯­
                    const goodComments = Array.from(document.querySelectorAll('input[name="good"]:checked'))
                        .map(cb => cb.value);
                    const improveComments = Array.from(document.querySelectorAll('input[name="improve"]:checked'))
                        .map(cb => cb.value);
                    
                    const additionalComment = document.getElementById('additionalComment').value;
                    
                    // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†è¯¾å ‚æ•ˆç‡ç›¸å…³çš„è¯„è¯­
                    const hasClassroomEfficiencyComments = improveComments.some(comment => 
                        comment.includes('è¯¾å ‚æ•ˆç‡') || comment.includes('è¯¾å ‚ä»»åŠ¡') || comment.includes('æ–°è¯¾çŸ¥è¯†')
                    );
                    
                    // æ„å»ºåé¦ˆ
                    let feedback = `ã€${studentName}åŒå­¦ä»Šæ—¥å­¦æƒ…åé¦ˆã€‘\n\n`;
                    feedback += `ğŸ“… æ—¥æœŸï¼š${date}\n`;
                    feedback += `ğŸ‘¨â€ğŸ« è¾…å¯¼è€å¸ˆï¼š${teacherName}\n\n`;
                    
                    feedback += `ğŸ“Š å­¦ä¹ æ¦‚å†µ\n`;
                    feedback += `   â€¢ ä½œä¸šæ€»é¡¹æ•°ï¼š${total}é¡¹\n`;
                    feedback += `   â€¢ å·²å®Œæˆé¡¹æ•°ï¼š${completed}é¡¹\n`;
                    feedback += `   â€¢ ä»Šæ—¥é”™é¢˜æ€»æ•°ï¼š${errorCount}é¢˜\n`;
                    feedback += `   â€¢ é¢„è®¡æ€»æ—¶é•¿ï¼š${totalEstimatedTime}åˆ†é’Ÿ\n`;
                    feedback += `   â€¢ å®é™…æ€»æ—¶é•¿ï¼š${totalActualTime}åˆ†é’Ÿ\n`;
                    feedback += `   â€¢ æ—¶é—´ä½¿ç”¨æƒ…å†µï¼š${timeUsageDescription}\n\n`;
                    
                    feedback += `ğŸ“š å„ç§‘ä½œä¸šè¯¦æƒ…\n`;
                    parsedAssignments.forEach(assignment => {
                        const status = assignment.completed ? 'âœ…' : 'âŒ';
                        
                        // æ—¶é—´æè¿°æ›´æ¸…æ™°
                        let timeDescription = `é¢„è®¡${assignment.estimatedTime}åˆ†é’Ÿ`;
                        if (assignment.completed && assignment.actualTime) {
                            timeDescription += `ï¼Œå®é™…å®Œæˆ${assignment.actualTime}åˆ†é’Ÿ`;
                        } else if (!assignment.completed) {
                            timeDescription += `ï¼Œæœªå®Œæˆ`;
                        }
                        
                        // è·å–é”™é¢˜åŸå› æè¿°
                        let errorReasonsDesc = '';
                        if (assignment.errorReasons && assignment.errorReasons !== '') {
                            const normalizedReasons = normalizeErrorReasons(assignment.errorReasons);
                            const reasonCodes = normalizedReasons.split(',').filter(code => code.trim() !== '');
                            const reasons = [];
                            reasonCodes.forEach(code => {
                                if (code && code.trim()) {
                                    const subjectErrors = errorReasons[assignment.subject];
                                    if (subjectErrors && subjectErrors[code.trim()]) {
                                        reasons.push(subjectErrors[code.trim()]);
                                    }
                                }
                            });
                            if (reasons.length > 0) {
                                errorReasonsDesc = reasons.join('ã€');
                            }
                        }
                        
                        feedback += `   ${status} ${assignment.subject}ï¼š${assignment.task}ï¼ˆ${timeDescription}ï¼‰`;
                        
                        const errorCountValue = assignment.errorCount ? parseInt(assignment.errorCount) : 0;
                        if (assignment.completed && !isNaN(errorCountValue)) {
                            if (errorCountValue > 0) {
                                feedback += `ï¼Œé”™é¢˜${errorCountValue}é¢˜`;
                                if (errorReasonsDesc) {
                                    feedback += `ï¼ˆ${errorReasonsDesc}ï¼‰`;
                                }
                            } else if (errorReasonsDesc) {
                                feedback += `ï¼Œé”™é¢˜0é¢˜ï¼ˆ${errorReasonsDesc}ï¼‰`;
                            } else {
                                feedback += `ï¼Œé”™é¢˜0é¢˜`;
                            }
                        }
                        feedback += '\n';
                    });
                    feedback += '\n';
                    
                    feedback += `ğŸ‘¨â€ğŸ« æ•™å¸ˆè¯„è¯­\n`;
                    
                    // æ·»åŠ å¥½çš„æ–¹é¢ - ä½¿ç”¨åˆ†å·åˆ†éš”
                    if (goodComments.length > 0) {
                        feedback += `   âœ… å¥½çš„æ–¹é¢ï¼š${goodComments.join('ï¼›')}\n`;
                    }
                    
                    // æ·»åŠ éœ€æ”¹è¿›æ–¹é¢ - ä½¿ç”¨åˆ†å·åˆ†éš”
                    if (improveComments.length > 0) {
                        feedback += `   âš ï¸ éœ€æ”¹è¿›ï¼š${improveComments.join('ï¼›')}\n`;
                    }
                    
                    if (additionalComment) {
                        feedback += `   ğŸ’¡ è¡¥å……ï¼š${additionalComment}\n`;
                    }
                    
                    feedback += `\nğŸ’ª å»ºè®®\n`;
                    
                    // ç¬¬ä¸€æ¡å»ºè®®
                    feedback += `   1. å…¸å‹é”™é¢˜ä¼šæ”¶å½•åˆ°è´å°”å®‰äº²é”™é¢˜å®ï¼Œé«˜æ•ˆæŸ¥æ¼è¡¥ç¼º\n`;
                    
                    // ç¬¬äºŒæ¡å»ºè®®ï¼šæ ¹æ®å„ç§‘é”™é¢˜æ•°ç»™å‡ºå»ºè®®
                    Object.keys(subjectErrorCounts).forEach(subject => {
                        const count = subjectErrorCounts[subject];
                        if (count > 5) {
                            feedback += `   2. ${subject}ä»Šæ—¥é”™é¢˜æ€»æ•°${count}é“ï¼Œé‡ç‚¹å…³æ³¨\n`;
                        }
                    });
                    
                    // ç¬¬ä¸‰æ¡å»ºè®®ï¼šå¦‚æœé€‰æ‹©äº†è¯¾å ‚æ•ˆç‡ç›¸å…³è¯„è¯­
                    if (hasClassroomEfficiencyComments) {
                        feedback += `   3. è¯·å…³æ³¨å­©å­åœ¨å­¦æ ¡çš„è¯¾å ‚æ•ˆç‡\n`;
                    }
                    
                    feedback += `\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                    feedback += `ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}\n`;
                    feedback += `è´å°”å®‰äº²ä¸€å°æ ¡åŒº\n`;
                    
                    document.getElementById('resultBox').textContent = feedback;
                } catch (error) {
                    console.error('ç”Ÿæˆåé¦ˆé”™è¯¯:', error);
                    alert('ç”Ÿæˆåé¦ˆæ—¶å‡ºé”™ï¼š' + error.message);
                } finally {
                    hideLoading();
                }
            }, 100);
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿ - ä¼˜åŒ–ç‰ˆï¼Œä¸“é—¨è§£å†³åä¸ºæ‰‹æœºå¤åˆ¶é—®é¢˜
        function copyToClipboard() {
            const feedback = document.getElementById('resultBox').textContent;
            
            if (!feedback || feedback === 'åé¦ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º...') {
                alert('è¯·å…ˆç”Ÿæˆåé¦ˆå†…å®¹ï¼');
                return;
            }
            
            // æ–¹æ³•1ï¼šå°è¯•ä½¿ç”¨ç°ä»£ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(feedback)
                    .then(() => {
                        showCopySuccess();
                    })
                    .catch(err => {
                        console.log('Clipboard API å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•:', err);
                        copyWithFallback(feedback);
                    });
            } else {
                // å¦‚æœä¸æ”¯æŒ Clipboard APIï¼Œç›´æ¥ä½¿ç”¨å¤‡ç”¨æ–¹æ³•
                copyWithFallback(feedback);
            }
        }
        
        // å¤‡ç”¨å¤åˆ¶æ–¹æ³•ï¼ˆå…¼å®¹åä¸ºæ‰‹æœºï¼‰
        function copyWithFallback(text) {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„textareaå…ƒç´ 
            const textArea = document.createElement('textarea');
            textArea.value = text;
            
            // è®¾ç½®ä¸ºåªè¯»ï¼Œé¿å…ç§»åŠ¨è®¾å¤‡é”®ç›˜å¼¹å‡º
            textArea.readOnly = true;
            
            // è®¾ç½®æ ·å¼ç¡®ä¿åœ¨å±å¹•ä¸Šä¸å¯è§
            textArea.style.position = 'fixed';
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            textArea.style.padding = '0';
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            textArea.style.background = 'transparent';
            textArea.style.opacity = '0';
            textArea.style.fontSize = '16px'; // è®¾ç½®å­—ä½“å¤§å°
            
            // æ·»åŠ åˆ°DOM
            document.body.appendChild(textArea);
            
            // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œéœ€è¦å…ˆèšç„¦å†é€‰æ‹©
            textArea.focus();
            
            // é€‰æ‹©æ–‡æœ¬
            textArea.select();
            textArea.setSelectionRange(0, text.length); // å¯¹äºç§»åŠ¨è®¾å¤‡
            
            // å°è¯•å¤åˆ¶
            let successful = false;
            try {
                successful = document.execCommand('copy');
            } catch (err) {
                console.error('execCommand å¤åˆ¶å¤±è´¥:', err);
            }
            
            // ç§»é™¤ä¸´æ—¶å…ƒç´ 
            document.body.removeChild(textArea);
            
            if (successful) {
                showCopySuccess();
            } else {
                // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œæ˜¾ç¤ºæ–‡æœ¬åŒºåŸŸè®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
                showManualCopy(text);
            }
        }
        
        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        function showCopySuccess() {
            // éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ–‡å­—
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'âœ… å·²å¤åˆ¶';
            copyBtn.style.backgroundColor = '#2ecc71';
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.style.backgroundColor = '';
            }, 2000);
        }
        
        // æ˜¾ç¤ºæ‰‹åŠ¨å¤åˆ¶ç•Œé¢ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function showManualCopy(text) {
            // åˆ›å»ºä¸€ä¸ªæ¨¡æ€æ¡†ç”¨äºæ‰‹åŠ¨å¤åˆ¶
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.zIndex = '9999';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.padding = '20px';
            
            // åˆ›å»ºå†…å®¹å®¹å™¨
            const content = document.createElement('div');
            content.style.backgroundColor = 'white';
            content.style.borderRadius = '10px';
            content.style.padding = '20px';
            content.style.width = '100%';
            content.style.maxWidth = '500px';
            content.style.maxHeight = '80vh';
            content.style.overflow = 'auto';
            
            // æ ‡é¢˜
            const title = document.createElement('h3');
            title.textContent = 'æ‰‹åŠ¨å¤åˆ¶';
            title.style.marginBottom = '15px';
            title.style.color = '#2c3e50';
            
            // æç¤ºæ–‡æœ¬
            const hint = document.createElement('p');
            hint.textContent = 'è¯·é•¿æŒ‰ä¸‹æ–¹æ–‡æœ¬å¹¶é€‰æ‹©"å¤åˆ¶"ï¼š';
            hint.style.marginBottom = '10px';
            hint.style.color = '#666';
            hint.style.fontSize = '14px';
            
            // æ–‡æœ¬åŒºåŸŸç”¨äºå¤åˆ¶
            const copyTextarea = document.createElement('textarea');
            copyTextarea.value = text;
            copyTextarea.readOnly = true;
            copyTextarea.style.width = '100%';
            copyTextarea.style.height = '200px';
            copyTextarea.style.padding = '10px';
            copyTextarea.style.border = '1px solid #ddd';
            copyTextarea.style.borderRadius = '5px';
            copyTextarea.style.fontSize = '14px';
            copyTextarea.style.lineHeight = '1.5';
            copyTextarea.style.resize = 'none';
            copyTextarea.style.marginBottom = '15px';
            
            // è‡ªåŠ¨é€‰ä¸­æ–‡æœ¬
            setTimeout(() => {
                copyTextarea.select();
                copyTextarea.setSelectionRange(0, text.length);
            }, 100);
            
            // æŒ‰é’®å®¹å™¨
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.justifyContent = 'flex-end';
            buttonContainer.style.gap = '10px';
            
            // å…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'å…³é—­';
            closeBtn.style.padding = '10px 20px';
            closeBtn.style.backgroundColor = '#f0f0f0';
            closeBtn.style.border = 'none';
            closeBtn.style.borderRadius = '5px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.fontSize = '14px';
            
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            closeBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                document.body.removeChild(modal);
            }, { passive: false });
            
            // ç»„è£…æ¨¡æ€æ¡†
            buttonContainer.appendChild(closeBtn);
            content.appendChild(title);
            content.appendChild(hint);
            content.appendChild(copyTextarea);
            content.appendChild(buttonContainer);
            modal.appendChild(content);
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(modal);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // ä¿å­˜ä¸ºæ–‡æœ¬æ–‡ä»¶
        function saveAsText() {
            const feedback = document.getElementById('resultBox').textContent;
            const studentName = document.getElementById('studentName').value || 'å­¦ç”Ÿ';
            const date = document.getElementById('date').value || new Date().toLocaleDateString('zh-CN');
            
            if (feedback && feedback !== 'åé¦ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º...') {
                try {
                    const blob = new Blob([feedback], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${studentName}_å­¦æƒ…åé¦ˆ_${date.replace(/\//g, '-')}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                } catch (error) {
                    console.error('ä¿å­˜æ–‡ä»¶é”™è¯¯:', error);
                    alert('ä¿å­˜æ–‡ä»¶æ—¶å‡ºé”™ï¼š' + error.message);
                }
            } else {
                alert('è¯·å…ˆç”Ÿæˆåé¦ˆå†…å®¹ï¼');
            }
        }
        
        // æ¸…ç©ºæ‰€æœ‰å†…å®¹
        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ')) {
                document.getElementById('ocrText').value = '';
                document.getElementById('studentName').value = '';
                document.getElementById('date').value = '';
                document.getElementById('teacherName').value = '';
                document.getElementById('additionalComment').value = '';
                document.getElementById('resultBox').textContent = 'åé¦ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º...';
                
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
                
                document.getElementById('totalTasks').textContent = '0';
                document.getElementById('completedTasks').textContent = '0';
                document.getElementById('totalErrors').textContent = '0';
                document.getElementById('subjectList').innerHTML = '<div class="hint">è¯·å…ˆè§£ææ–‡æœ¬å†…å®¹</div>';
                
                parsedAssignments = [];
            }
        }
        
        // äº‹ä»¶ç»‘å®šå‡½æ•°
        function bindEvents() {
            // æ™ºèƒ½è§£ææŒ‰é’®
            parseBtn.addEventListener('click', parseContent);
            parseBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                parseContent();
            }, { passive: false });
            
            // æ¸…ç©ºæŒ‰é’®
            clearBtn.addEventListener('click', clearAll);
            clearBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                clearAll();
            }, { passive: false });
            
            // ç”Ÿæˆåé¦ˆæŒ‰é’®
            generateBtn.addEventListener('click', generateFeedback);
            generateBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                generateFeedback();
            }, { passive: false });
            
            // å¤åˆ¶æŒ‰é’®
            copyBtn.addEventListener('click', copyToClipboard);
            copyBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                copyToClipboard();
            }, { passive: false });
            
            // ä¿å­˜æŒ‰é’®
            saveBtn.addEventListener('click', saveAsText);
            saveBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                saveAsText();
            }, { passive: false });
            
            // ä¸ºå¤é€‰æ¡†æ·»åŠ è§¦æ‘¸æ”¯æŒ
            document.querySelectorAll('.comment-checkbox').forEach(checkbox => {
                checkbox.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                }, { passive: true });
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºç³»ç»Ÿæ—¥æœŸ
            const today = new Date();
            const formattedDate = `${today.getFullYear()}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')}`;
            document.getElementById('date').value = formattedDate;
            
            // ç»‘å®šäº‹ä»¶
            bindEvents();
            
            // è‡ªåŠ¨è§£æ
            setTimeout(() => {
                if (document.getElementById('ocrText').value.trim()) {
                    parseContent();
                }
            }, 1000);
        });
        
        // é˜²æ­¢ç§»åŠ¨ç«¯åŒå‡»ç¼©æ”¾
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>

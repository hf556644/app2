<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贝尔安亲作业反馈系统 - 加密访问系统</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div id="auth-screen" class="screen">
            <div class="logo">
                <i class="fas fa-lock"></i>
                <h1>贝尔安亲作业反馈系统 - 安全访问</h1>
            </div>
            
            <div class="auth-box">
                <div class="qr-overlay">
                    <i class="fas fa-qrcode"></i>
                    <p>请使用本月有效二维码扫描访问贝尔安亲作业反馈系统</p>
                </div>
                
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>验证中...</p>
                </div>
                
                <div id="content" class="content hidden">
                    <!-- 这里放置你的实际内容 -->
                    <h2>欢迎访问贝尔安亲作业反馈系统</h2>
                    <div class="info-card">
                        <h3><i class="fas fa-calendar-check"></i> 本月有效</h3>
                        <p>当前访问时间: <span id="current-date"></span></p>
                        <p>有效期至: <span id="expiry-date"></span></p>
                    </div>
                    
                    <div class="features">
                        <div class="feature">
                            <i class="fas fa-shield-alt"></i>
                            <h4>安全加密</h4>
                            <p>每月动态更新访问凭证</p>
                        </div>
                        <div class="feature">
                            <i class="fas fa-mobile-alt"></i>
                            <h4>移动优化</h4>
                            <p>完美适配手机端访问</p>
                        </div>
                        <div class="feature">
                            <i class="fas fa-sync-alt"></i>
                            <h4>自动更新</h4>
                            <p>每月自动更换安全密钥</p>
                        </div>
                    </div>
                    
                    <div class="actions">
                        <!-- 重要：修改这里为你第二个应用的实际文件 -->
                        <button onclick="window.open('贝尔安亲作业反馈系统.html', '_blank')" class="btn-primary">
                            <i class="fas fa-external-link-alt"></i> 进入贝尔安亲作业反馈系统
                        </button>
                        <button onclick="location.reload()" class="btn-secondary">
                            <i class="fas fa-redo"></i> 重新验证
                        </button>
                    </div>
                </div>
                
                <div id="error" class="error hidden">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>访问被拒绝</h3>
                    <p id="error-message"></p>
                    <button onclick="location.reload()" class="btn-retry">
                        <i class="fas fa-redo"></i> 重试
                    </button>
                </div>
            </div>
            
            <div class="footer">
                <p><i class="fas fa-info-circle"></i> 如需获取第二个应用二维码，请联系系统管理员</p>
                <p class="version">v1.0 | 有效期: <span id="token-month"></span></p>
            </div>
        </div>
    </div>
    
    <!-- 注意：这里引用app2目录下的auth.js，而不是根目录的 -->
    <script>
        // 认证逻辑
        class AuthSystem {
            constructor() {
                this.config = null;
                this.currentToken = this.getTokenFromURL();
                this.attempts = 0;
                this.maxAttempts = 3;
            }

            // 从URL获取token
            getTokenFromURL() {
                const params = new URLSearchParams(window.location.search);
                return params.get('token') || params.get('t');
            }

            // 获取当前月份（两位数字，如01、02）
            getCurrentMonth() {
                const now = new Date();
                const month = now.getMonth() + 1;
                return month.toString().padStart(2, '0');
            }

            // 加载配置
            async loadConfig() {
                try {
                   const response = await fetch('config.json');
                    this.config = await response.json();
                    return true;
                } catch (error) {
                    console.error('加载配置失败:', error);
                    return false;
                }
            }

            // 验证token
            async validateToken() {
                if (!this.currentToken) {
                    throw new Error('缺少访问令牌');
                }

                if (!await this.loadConfig()) {
                    throw new Error('系统配置加载失败');
                }

                // 获取当前月份
                const currentMonth = this.getCurrentMonth();
                
                // 检查当前月份是否有对应的令牌
                if (!this.config.tokens || !this.config.tokens[currentMonth]) {
                    throw new Error('本月暂无有效访问令牌，请联系管理员');
                }

                // 验证token是否匹配
                const monthToken = this.config.tokens[currentMonth];
                
                if (this.currentToken !== monthToken) {
                    this.attempts++;
                    if (this.attempts >= this.maxAttempts) {
                        throw new Error('验证失败次数过多，请重新扫描二维码');
                    }
                    throw new Error(`无效的访问令牌 (尝试 ${this.attempts}/${this.maxAttempts})`);
                }

                return true;
            }

            // 更新页面信息
            updatePageInfo() {
                if (!this.config) return;
                
                const currentMonth = this.getCurrentMonth();
                const expiry = new Date(new Date().getFullYear(), parseInt(currentMonth), 0); // 当月最后一天
                
                const currentDate = document.getElementById('current-date');
                const expiryDate = document.getElementById('expiry-date');
                const tokenMonth = document.getElementById('token-month');
                
                if (currentDate) {
                    currentDate.textContent = new Date().toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
                
                if (expiryDate) {
                    expiryDate.textContent = expiry.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
                
                if (tokenMonth) {
                    tokenMonth.textContent = expiry.toLocaleDateString('zh-CN', { month: 'long', year: 'numeric' });
                }
            }

            // 主验证流程
            async authenticate() {
                const loading = document.getElementById('loading');
                const content = document.getElementById('content');
                const error = document.getElementById('error');

                try {
                    await this.validateToken();
                    
                    // 验证成功
                    if (loading) loading.classList.add('hidden');
                    this.updatePageInfo();
                    if (content) content.classList.remove('hidden');
                    
                    // 记录访问日志
                    this.logAccess();
                    
                } catch (errorMsg) {
                    // 验证失败
                    if (loading) loading.classList.add('hidden');
                    const errorMessage = document.getElementById('error-message');
                    if (errorMessage) errorMessage.textContent = errorMsg;
                    if (error) error.classList.remove('hidden');
                }
            }

            // 记录访问日志
            logAccess() {
                const log = {
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    token: this.currentToken ? this.currentToken.substring(0, 8) + '...' : 'none',
                    verified: true
                };
                console.log('访问记录:', log);
            }
        }

        // 页面加载时启动验证
        document.addEventListener('DOMContentLoaded', () => {
            const auth = new AuthSystem();
            auth.authenticate();
        });
    </script>
    
    <script>
        // 主功能脚本（原main.js的内容）
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化日期显示
            updateDateTime();
            setInterval(updateDateTime, 60000); // 每分钟更新一次
            
            // 添加一些交互效果
            addHoverEffects();
        });

        function updateDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            const dateTimeStr = now.toLocaleDateString('zh-CN', options);
            
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                dateElement.textContent = dateTimeStr;
            }
        }

        function addHoverEffects() {
            // 为按钮添加涟漪效果
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;
                    
                    ripple.style.cssText = `
                        position: absolute;
                        border-radius: 50%;
                        background: rgba(255, 255, 255, 0.7);
                        transform: scale(0);
                        animation: ripple 0.6s linear;
                        width: ${size}px;
                        height: ${size}px;
                        left: ${x}px;
                        top: ${y}px;
                    `;
                    
                    this.appendChild(ripple);
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });
        }

        // 添加CSS动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes ripple {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
